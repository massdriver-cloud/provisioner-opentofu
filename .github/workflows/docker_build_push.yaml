name: Build and Push Docker Images

on:
  push:
    tags:
      - "release-*"
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        opentofu_version: [1.6.3, 1.7.8, 1.8.9, 1.9.1, 1.10.1]  # Full semver versions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract major.minor version and determine latest
        id: version_processing
        run: |
          # Extract major.minor version (e.g., 1.2.3 -> 1.2)
          VERSION="${{ matrix.opentofu_version }}"
          MAJOR_MINOR=$(echo "$VERSION" | awk -F. '{print $1"."$2}')
          echo "MAJOR_MINOR_VERSION=$MAJOR_MINOR" >> $GITHUB_ENV

          # Prepare a sorted list to determine the latest version
          versions=($(echo "${{ join(matrix.opentofu_version, ' ') }}" | tr ' ' '\n' | sort -V))
          latest_full_version=${versions[-1]}
          latest_major_minor=$(echo "$latest_full_version" | awk -F. '{print $1"."$2}')

          echo "LATEST_MAJOR_MINOR_VERSION=$latest_major_minor" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.PUBLIC_DOCKER_HUB_USERNAME }}
          password: ${{ secrets.PUBLIC_DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: massdrivercloud/provisioner-opentofu:${{ env.MAJOR_MINOR_VERSION }}${{ env.MAJOR_MINOR_VERSION == env.LATEST_MAJOR_MINOR_VERSION && ',massdrivercloud/provisioner-opentofu:latest' || '' }}
          build-args: OPENTOFU_VERSION=${{ matrix.opentofu_version }}